<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 20px; }
  h2 { color: #333; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  input, select, textarea { padding: 5px; margin: 5px 0; width: 100%; max-width: 300px; }
  button { padding: 8px 12px; background: #007bff; color: white; border: none; cursor: pointer; }
  button:disabled { background: #aaa; }
  .section { background: white; padding: 15px; margin-bottom: 30px; border-radius: 8px; }
  label { font-weight: bold; display: block; margin-top: 10px; }
</style>
<script type="module">
  const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, onSnapshot, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // App settings
  let appSettings = {};

  async function loadOverview() {
    const usersSnapshot = await getDocs(collection(db, "users"));
    const withdrawalsSnapshot = await getDocs(collection(db, "withdrawals"));
    document.getElementById("total-users").textContent = usersSnapshot.size;
    document.getElementById("total-withdrawals").textContent = withdrawalsSnapshot.size;
  }

  async function loadUsers() {
    const tbody = document.querySelector("#users-table tbody");
    tbody.innerHTML = "";
    const usersSnapshot = await getDocs(collection(db, "users"));
    usersSnapshot.forEach(docSnap => {
      const user = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.balance}</td>
        <td>${user.blocked ? "Blocked" : "Active"}</td>
        <td>
          <button onclick="toggleBlockUser('${docSnap.id}')">${user.blocked ? "Unblock" : "Block"}</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function toggleBlockUser(userId) {
    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const currentBlocked = userSnap.data().blocked || false;
      await updateDoc(userRef, { blocked: !currentBlocked });
      loadUsers();
    }
  }

  async function loadWithdrawals() {
    const tbody = document.querySelector("#withdrawals-table tbody");
    tbody.innerHTML = "";
    const withdrawalsSnapshot = await getDocs(collection(db, "withdrawals"));
    for(const docSnap of withdrawalsSnapshot.docs) {
      const wd = docSnap.data();
      const userRef = doc(db, "users", wd.userId);
      const userSnap = await getDoc(userRef);
      const userName = userSnap.exists() ? userSnap.data().name : "Unknown";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${userName}</td>
        <td>${wd.amount}</td>
        <td>${wd.method}</td>
        <td>${wd.status}</td>
        <td>
          ${wd.status === "Pending" ? `
          <button onclick="approveWithdrawal('${docSnap.id}')">Approve</button>
          <button onclick="rejectWithdrawal('${docSnap.id}')">Reject</button>` : ""}
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function approveWithdrawal(wdId) {
    const wdRef = doc(db, "withdrawals", wdId);
    await updateDoc(wdRef, { status: "Approved" });
    loadWithdrawals();
  }

  async function rejectWithdrawal(wdId) {
    const wdRef = doc(db, "withdrawals", wdId);
    await updateDoc(wdRef, { status: "Rejected" });
    loadWithdrawals();
  }

  async function loadSettings() {
    // We will keep settings in a single doc "appSettings" inside "settings" collection
    const settingsRef = doc(db, "settings", "appSettings");
    const settingsSnap = await getDoc(settingsRef);
    if(settingsSnap.exists()) {
      appSettings = settingsSnap.data();
      document.getElementById("minWithdrawal").value = appSettings.minWithdrawal || 100;
      document.getElementById("coinValue").value = appSettings.coinValue || 10;
      document.getElementById("paymentMethods").value = appSettings.paymentMethods || "UPI,Paytm";
      document.getElementById("equivalentValue").value = appSettings.equivalentValue || 1;
      document.getElementById("visitEarnTasks").value = appSettings.visitEarnTasks || JSON.stringify([{ task: "Visit website", reward: 10 }], null, 2);
    } else {
      // Defaults
      document.getElementById("minWithdrawal").value = 100;
      document.getElementById("coinValue").value = 10;
      document.getElementById("paymentMethods").value = "UPI,Paytm";
      document.getElementById("equivalentValue").value = 1;
      document.getElementById("visitEarnTasks").value = JSON.stringify([{ task: "Visit website", reward: 10 }], null, 2);
    }
  }

  async function saveSettings(e) {
    e.preventDefault();
    appSettings.minWithdrawal = parseInt(document.getElementById("minWithdrawal").value);
    appSettings.coinValue = parseInt(document.getElementById("coinValue").value);
    appSettings.paymentMethods = document.getElementById("paymentMethods").value;
    appSettings.equivalentValue = parseInt(document.getElementById("equivalentValue").value);
    appSettings.visitEarnTasks = document.getElementById("visitEarnTasks").value;
    const settingsRef = doc(db, "settings", "appSettings");
    await setDoc(settingsRef, appSettings);
    alert("Settings saved.");
  }

  window.onload = () => {
    loadOverview();
    loadUsers();
    loadWithdrawals();
    loadSettings();
    document.getElementById("app-settings-form").onsubmit = saveSettings;
  };
</script>
</head>
<body>

<div class="section">
  <h2>Overview</h2>
  <p>Total Users: <span id="total-users">0</span></p>
  <p>Total Withdrawals: <span id="total-withdrawals">0</span></p>
</div>

<div class="section">
  <h2>Users</h2>
  <table id="users-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Balance (Coins)</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h2>Withdrawals</h2>
  <table id="withdrawals-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Amount (Coins)</th>
        <th>Payment Method</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h2>App Settings</h2>
  <form id="app-settings-form">
    <label for="minWithdrawal">Minimum Withdrawal (Coins)</label>
    <input type="number" id="minWithdrawal" name="minWithdrawal" min="0" />

    <label for="coinValue">Coin Value (Coins)</label>
    <input type="number" id="coinValue" name="coinValue" min="1" />

    <label for="paymentMethods">Payment Methods (comma separated)</label>
    <input type="text" id="paymentMethods" name="paymentMethods" />

    <label for="equivalentValue">Equivalent Value (INR)</label>
    <input type="number" id="equivalentValue" name="equivalentValue" min="0" />

    <label for="visitEarnTasks">Visit & Earn Tasks (JSON format)</label>
    <textarea id="visitEarnTasks" name="visitEarnTasks" rows="5" style="width:100%;"></textarea>

    <button type="submit">Save Settings</button>
  </form>
</div>

</body>
        </html>
        
