<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Tapper | Play & Earn</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <style>
        :root { --bg: #0d1a3a; --card: #1e293b; --accent: #00e5ff; --text: #ffffff; --success: #22c55e; --pending: #f59e0b; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        header { padding: 15px; text-align: center; border-bottom: 1px solid rgba(0,229,255,0.2); background: rgba(13,26,58,0.8); backdrop-filter: blur(10px); }
        #bottomNav { position: fixed; bottom: 0; width: 100%; height: 70px; display: flex; justify-content: space-around; align-items: center; background: #070f25; border-top: 1px solid rgba(0,229,255,0.2); }
        .nav-item { color: #a0aec0; font-size: 0.65rem; text-align: center; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .page { display: none; flex: 1; overflow-y: auto; padding: 20px 20px 90px; }
        .page.active { display: block; }
        #coinBtn { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, #ffe082, #ffb300); margin: 30px auto; display: flex; align-items: center; justify-content: center; font-size: 70px; box-shadow: 0 0 40px rgba(255,179,0,0.3); cursor: pointer; transition: transform 0.05s; user-select: none; border: 6px solid rgba(255,255,255,0.2); }
        #coinBtn:active { transform: scale(0.92); }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(0,229,255,0.1); }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--accent); color: #0d1a3a; margin-top: 10px; }
        .btn:disabled { background: #4a5568; opacity: 0.6; cursor: not-allowed; color: white; }
        input, select { width: 100%; padding: 12px; background: #070f25; border: 1px solid rgba(0,229,255,0.2); color: white; border-radius: 8px; margin-top: 8px; }
        .plus-one { position: absolute; color: var(--accent); font-weight: bold; font-size: 1.5rem; pointer-events: none; animation: float 0.8s forwards; }
        @keyframes float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
        .sparkle { position: absolute; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; pointer-events: none; animation: burst 0.5s ease-out forwards; }
        @keyframes burst { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0) translateX(var(--x)) translateY(var(--y)); opacity: 0; } }
        #ad-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; display: none; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 0.7rem; color: #a0aec0;">TOTAL POINTS</div>
        <h2 id="balance">0 Pts</h2>
        <div id="usdBalance" style="color: var(--success); font-size: 0.8rem;">$0.00</div>
    </header>

    <div id="tapPage" class="page active">
        <div id="coinBtn">âš¡</div>
        <div style="width: 80%; margin: 0 auto; text-align: center;">
            <div style="width: 100%; height: 8px; background: #1a365d; border-radius: 4px; overflow: hidden;">
                <div id="energyFill" style="height: 100%; background: var(--accent); width: 100%;"></div>
            </div>
            <p id="energyText" style="margin-top: 5px; font-size: 0.7rem; color: #a0aec0;">1000 / 1000</p>
        </div>
    </div>

    <div id="tasksPage" class="page">
        <h3>Tasks</h3><div id="taskList"></div>
    </div>

    <div id="referPage" class="page">
        <h3>Refer Friends</h3>
        <div class="card"><p style="font-size: 0.8rem; color: #a0aec0;">Your ID:</p><h2 id="myId" style="color: var(--accent);">...</h2><p id="refRewardText" style="font-size:0.8rem; margin-top:10px;"></p></div>
        <div class="card"><input type="text" id="refInput" placeholder="Enter Friend's ID"><button class="btn" onclick="claimReferral()">Claim Bonus</button></div>
    </div>

    <div id="withdrawPage" class="page">
        <h3>Withdraw</h3>
        <div class="card">
            <select id="wdMethod"><option value="PayPal">PayPal</option><option value="Binance">Binance</option><option value="Bkash">Bkash</option></select>
            <input type="text" id="wdAddress" placeholder="Payment Address"><input type="number" id="wdAmount" placeholder="Points">
            <button class="btn" onclick="requestPayout()">Submit Request</button>
        </div>
        <h4 style="margin: 15px 0 10px;">History</h4>
        <div id="wdHistory"></div>
    </div>

    <nav id="bottomNav">
        <div class="nav-item active" onclick="showPage('tapPage', this)"><div>ðŸ”˜</div>Tap</div>
        <div class="nav-item" onclick="showPage('tasksPage', this)"><div>ðŸ“‹</div>Tasks</div>
        <div class="nav-item" onclick="showPage('referPage', this)"><div>ðŸ‘¥</div>Refer</div>
        <div class="nav-item" onclick="showPage('withdrawPage', this)"><div>ðŸ’°</div>Wallet</div>
    </nav>
    
    <div id="ad-modal"><h2>Ad Break!</h2><p>Please wait a moment...</p></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDDk76dNMeHv52i8TYshx_lIfMKKYmQ6O0", authDomain: "earnmeappbot.firebaseapp.com", databaseURL: "https://earnmeappbot-default-rtdb.firebaseio.com", projectId: "earnmeappbot", storageBucket: "earnmeappbot.firebasestorage.app", messagingSenderId: "418298281867", appId: "1:418298281867:web:1e9fefbc11ac678c98b98e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let uid = localStorage.getItem('et_uid') || 'U' + Math.floor(Math.random() * 900000);
        localStorage.setItem('et_uid', uid);
        document.getElementById('myId').innerText = uid;

        let userData = null, settings = { coinValue: 10000, waitTime: 10, refReward: 500, adClickThreshold: 100 }, timers = {}, clickCounter = 0;

        // --- Data Listeners ---
        db.ref('settings').on('value', s => { 
            settings = s.val() || settings; 
            document.getElementById('refRewardText').innerText = `Your friend gets ${settings.refReward} points!`;
            updateUI(); 
        });

        db.ref('users/' + uid).on('value', s => {
            if(!s.val()) db.ref('users/' + uid).set({ points: 0, energy: 1000, completed: [], claimedRef: false });
            else { userData = s.val(); updateUI(); }
        });

        // --- Core UI Update ---
        function updateUI() {
            if(!userData) return;
            document.getElementById('balance').innerText = userData.points.toLocaleString() + " Pts";
            document.getElementById('usdBalance').innerText = "$" + (userData.points / settings.coinValue).toFixed(2);
            document.getElementById('energyFill').style.width = (userData.energy / 10) + "%";
            document.getElementById('energyText').innerText = Math.floor(userData.energy) + " / 1000";
            renderTasks();
            renderHistory();
        }

        // --- Tapping & Ad Logic ---
        function handleTap(e) {
            const currentEnergy = userData ? userData.energy : 0;
            if (currentEnergy < 1) return;

            const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            createEffects(x, y);

            // Use a transaction for safe, atomic updates
            db.ref('users/' + uid).transaction(currentUser => {
                if (currentUser && currentUser.energy > 0) {
                    currentUser.points = (currentUser.points || 0) + 1;
                    currentUser.energy -= 1;
                }
                return currentUser;
            });

            clickCounter++;
            if(clickCounter >= settings.adClickThreshold) {
                showAdBreak();
                clickCounter = 0;
            }
        }
        document.getElementById('coinBtn').addEventListener('touchstart', (e) => { e.preventDefault(); handleTap(e); });
        document.getElementById('coinBtn').addEventListener('mousedown', handleTap);

        function createEffects(x, y) {
            const p = document.createElement('div'); p.className = 'plus-one';
            p.style.left = x + 'px'; p.style.top = y + 'px'; p.innerText = '+1';
            document.body.appendChild(p); setTimeout(() => p.remove(), 800);
            for(let i=0; i<5; i++) {
                const s = document.createElement('div'); s.className = 'sparkle';
                s.style.left = x + 'px'; s.style.top = y + 'px';
                s.style.setProperty('--x', (Math.random() - 0.5) * 60 + 'px');
                s.style.setProperty('--y', (Math.random() - 0.5) * 60 + 'px');
                document.body.appendChild(s); setTimeout(() => s.remove(), 500);
            }
        }
        
        function showAdBreak() {
            const modal = document.getElementById('ad-modal');
            modal.style.display = 'flex';
            setTimeout(() => { modal.style.display = 'none'; }, 2500);
        }

        // --- Task Logic ---
        function renderTasks() {
            db.ref('tasks').once('value', s => {
                const list = document.getElementById('taskList'); list.innerHTML = "";
                s.forEach(c => {
                    const t = c.val(), tid = c.key;
                    if(userData.completed && userData.completed.includes(tid)) return;
                    
                    const timeLeft = timers[tid];
                    const card = document.createElement('div'); card.className = "card";
                    let btnHTML = `<button class="btn" onclick="startTimer('${tid}', '${t.link1}')">Step 1: Open Link</button>`;
                    
                    if(timeLeft > 0) btnHTML = `<button class="btn" disabled>Please wait ${timeLeft}s...</button>`;
                    else if(timeLeft === 0) btnHTML = `<button class="btn" onclick="finishTask('${tid}', '${t.link2}')">Step 2: Go to ${t.type}</button>`;

                    card.innerHTML = `<h4>${t.title}</h4><div style="margin-top:5px">${btnHTML}</div>`;
                    list.appendChild(card);
                });
            });
        }

        function startTimer(tid, link) {
            window.open(link, '_blank');
            timers[tid] = settings.waitTime;
            const interval = setInterval(() => {
                timers[tid]--;
                renderTasks();
                if(timers[tid] <= 0) { clearInterval(interval); timers[tid] = 0; renderTasks(); }
            }, 1000);
            renderTasks();
        }

        function finishTask(tid, link) {
            window.open(link, '_blank');
            const done = userData.completed || []; done.push(tid);
            db.ref('tasks/' + tid).once('value', snap => {
                db.ref('users/' + uid).update({ points: userData.points + snap.val().reward, completed: done });
            });
            delete timers[tid];
        }
        
        // --- Referral Logic ---
        function claimReferral() {
            const refId = document.getElementById('refInput').value.trim();
            if(refId === uid || userData.claimedRef) return alert("Invalid Code or Already Claimed");
            
            db.ref('users/' + refId).once('value', s => {
                if(s.exists()) {
                    db.ref('users/' + refId).update({ points: s.val().points + settings.refReward });
                    db.ref('users/' + uid).update({ claimedRef: true, points: userData.points + 100 });
                    alert("Referral successful!");
                } else {
                    alert("Referral ID not found.");
                }
            });
        }

        // --- Payout Logic ---
        function requestPayout() {
            const amt = parseInt(document.getElementById('wdAmount').value);
            const addr = document.getElementById('wdAddress').value;
            const meth = document.getElementById('wdMethod').value;
            if(!addr || !amt) return alert("Please fill all fields.");
            if(amt > userData.points || amt < settings.coinValue * 0.5) return alert("Invalid amount or insufficient points.");
            
            db.ref('payouts').push({ uid, amt, addr, method: meth, status: 'pending', date: Date.now() });
            db.ref('users/' + uid).update({ points: userData.points - amt });
            alert("Withdrawal request submitted!");
        }

        function renderHistory() {
            db.ref('payouts').orderByChild('uid').equalTo(uid).once('value', s => {
                const h = document.getElementById('wdHistory'); h.innerHTML = "";
                s.forEach(c => {
                    const p = c.val();
                    const statusColor = p.status === 'paid' ? 'var(--success)' : 'var(--pending)';
                    const statusText = p.status === 'paid' ? 'Successful' : 'Pending';
                    h.innerHTML += `<div class="card" style="font-size:0.7rem; display:flex; justify-content:space-between"><span>${p.method} - ${p.amt} Pts</span><b style="color:${statusColor}">${statusText}</b></div>`;
                });
            });
        }

        // --- Navigation & Timers ---
        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        setInterval(() => { if(userData && userData.energy < 1000) db.ref('users/' + uid).update({ energy: Math.min(1000, userData.energy + 2) }); }, 3000);
    </script>
</body>
</html>